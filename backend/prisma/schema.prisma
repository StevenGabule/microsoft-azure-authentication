generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum MfaMethod {
  TOTP
  AZURE_AD_MFA
}

model User {
  id                String    @id @default(cuid())
  microsoftId       String    @unique @map("microsoft_id")
  email             String    @unique
  displayName       String?   @map("display_name")
  firstName         String?   @map("first_name")
  lastName          String?   @map("last_name")
  avatarUrl         String?   @map("avatar_url")
  jobTitle          String?   @map("job_title")
  department        String?
  role              Role      @default(USER)

  mfaEnabled        Boolean   @default(false) @map("mfa_enabled")
  mfaMethod         MfaMethod? @map("mfa_method")
  mfaSecret         String?   @map("mfa_secret")
  mfaRecoveryCodes  String[]  @map("mfa_recovery_codes")
  mfaVerifiedAt     DateTime? @map("mfa_verified_at")

  isActive          Boolean   @default(true) @map("is_active")
  lastLoginAt       DateTime? @map("last_login_at")
  lastLoginIp       String?   @map("last_login_ip")

  sessions          Session[]
  refreshTokens     RefreshToken[]
  auditLogs         AuditLog[]

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("users")
  @@index([email])
  @@index([microsoftId])
}

model Session {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  deviceInfo    String?  @map("device_info")
  mfaCompleted  Boolean  @default(false) @map("mfa_completed")

  expiresAt     DateTime @map("expires_at")
  revokedAt     DateTime? @map("revoked_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("sessions")
  @@index([userId])
  @@index([expiresAt])
}

model RefreshToken {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash      String   @unique @map("token_hash")
  family         String   @default(cuid())
  expiresAt      DateTime @map("expires_at")
  revokedAt      DateTime? @map("revoked_at")
  replacedByHash String?  @map("replaced_by_hash")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("refresh_tokens")
  @@index([userId])
  @@index([tokenHash])
  @@index([family])
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?  @map("user_id")
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action      String
  resource    String?
  details     Json?
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  success     Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
